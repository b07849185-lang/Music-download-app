name: ğŸš€ Production Deploy (2026 Edition)

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'        # ÙŠØ´ØªØºÙ„ ÙÙ‚Ø· Ù„Ùˆ Ø¹Ø¯Ù„Øª ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
      - '.github/workflows/**' # Ø£Ùˆ Ø¹Ø¯Ù„Øª ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¯ÙŠØ¨ÙˆÙ„ Ù†ÙØ³Ù‡

jobs:
  deploy-server:
    name: ğŸ“¦ Deploy to High-Performance Server
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›¡ï¸ Security Check & Checkout
      uses: actions/checkout@v4

    - name: âš¡ Execute Remote Deployment via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script_stop: true # ÙŠÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹ Ù„Ùˆ Ø­ØµÙ„ Ø£ÙŠ Ø®Ø·Ø£
        timeout: 30m
        script: |
          # --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø© (Setup Environment) ---
          export PROJECT_DIR=~/liquid-glass-app
          mkdir -p $PROJECT_DIR
          cd $PROJECT_DIR

          # --- 2. Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Smart Pull) ---
          # ÙŠØ³ØªØ®Ø¯Ù… Reset Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø¬ÙŠØ« Ù‡ÙˆØ¨ 100% ÙˆÙ…Ø³Ø­ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙŠØ¯ÙˆÙŠØ© Ø®Ø§Ø·Ø¦Ø©
          if [ -d ".git" ]; then
            echo "ğŸ”„ Updating existing repository..."
            git fetch origin main
            git reset --hard origin/main
          else
            echo "â¬‡ï¸ Cloning fresh repository..."
            git clone https://github.com/${{ github.repository }}.git .
          fi

          # --- 3. Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ---
          cd backend

          # --- 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± Ø¨Ù‚ÙˆØ© Ø§Ù„Ù€ 16 ÙƒÙˆØ± (Build Power) ---
          echo "ğŸ”¨ Building Docker Image with 16-Core optimization..."
          # ØªÙØ¹ÙŠÙ„ BuildKit Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡ 3 Ø£Ø¶Ø¹Ø§Ù
          export DOCKER_BUILDKIT=1
          docker build -t liquid-engine:latest .

          # --- 5. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Zero-Downtime Strategy) ---
          echo "ğŸ›‘ Stopping old container..."
          docker stop liquid-container || true
          docker rm liquid-container || true

          # --- 6. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ­Ø´ (Run Container) ---
          echo "ğŸš€ Starting new container..."
          docker run -d \
            --name liquid-container \
            --restart unless-stopped \
            -p 8000:8000 \
            --cpus="14.0" \
            --memory="90g" \
            --log-driver json-file --log-opt max-size=10m --log-opt max-file=3 \
            liquid-engine:latest

          # --- 7. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø®Ù„ÙØ§Øª (Garbage Collection) ---
          # ÙŠÙ…Ø³Ø­ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©
          echo "ğŸ§¹ Cleaning up system..."
          docker image prune -f

          # --- 8. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø© (Health Check) ---
          echo "ğŸ’“ Checking server pulse..."
          sleep 5
          if curl -s http://localhost:8000/ > /dev/null; then
              echo "âœ… Deployment Successful! Server is Online."
          else
              echo "âŒ Server failed to respond!"
              exit 1
          fi
